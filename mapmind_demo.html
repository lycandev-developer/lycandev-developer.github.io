<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mindspace Explorer</title>
  <style>
    html, body {
      margin: 0;
      background: #111;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }

    svg {
      width: 100vw;
      height: 100vh;
      cursor: crosshair;
    }

    .edit-box {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: #1a1a1a;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid white;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .edit-box input {
      border: 1px solid white;
      background: #222;
      color: white;
      padding: 4px;
    }

    .edit-box button {
      background: #333;
      color: white;
      border: 1px solid white;
      padding: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <svg></svg>
  <div class="edit-box" style="display:none;">
    <input id="node-label" placeholder="Node label" />
    <input id="node-color" type="color" />
    <button id="save-node">Save</button>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const svg = d3.select("svg");
    const width = window.innerWidth;
    const height = window.innerHeight;

    let nodes = [];
    let links = [];
    let selectedNode = null;
    let editingNode = null;

    const gLinks = svg.append("g").attr("stroke", "white").attr("stroke-width", 2);
    const gNodes = svg.append("g");

    function invertColor(hex) {
      const c = d3.color(hex);
      if (!c) return "white";
      const luminance = 0.299 * c.r + 0.587 * c.g + 0.114 * c.b;
      return luminance > 186 ? "black" : "white";
    }

    function update() {
      gLinks.selectAll("line")
        .data(links)
        .join("line")
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

      const node = gNodes.selectAll("g")
        .data(nodes, d => d.id)
        .join(enter => {
          const g = enter.append("g")
            .call(drag)
            .on("click", (event, d) => {
              event.stopPropagation();
              if (!selectedNode) {
                selectedNode = d;
                update();
              } else if (selectedNode !== d) {
                links.push({ source: selectedNode, target: d });
                selectedNode = null;
                update();
              } else {
                selectedNode = null;
                update();
              }
            })
            .on("contextmenu", (event, d) => {
              event.preventDefault();
              nodes = nodes.filter(n => n !== d);
              links = links.filter(l => l.source !== d && l.target !== d);
              if (selectedNode === d) selectedNode = null;
              update();
            });

          g.append("circle")
            .attr("r", 30);

          g.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em")
            .style("pointer-events", "none");

          return g;
        });

      gNodes.selectAll("g")
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .select("circle")
        .attr("fill", d => d.color || "#5555ff")
        .attr("stroke", d => d === selectedNode ? "cyan" : "white")
        .attr("stroke-width", d => d === selectedNode ? 4 : 2);

      gNodes.selectAll("text")
        .text(d => d.label)
        .attr("fill", d => invertColor(d.color || "#5555ff"));
    }

    function drag(sim) {
      return d3.drag()
        .on("start", (event, d) => {
          d.fx = d.x;
          d.fy = d.y;
        })
        .on("drag", (event, d) => {
          d.fx = event.x;
          d.fy = event.y;
          d.x = event.x;
          d.y = event.y;
          update();
        })
        .on("end", (event, d) => {
          d.fx = null;
          d.fy = null;
        });
    }

    svg.on("click", function (event) {
      if (event.target.tagName !== "svg") return;
      const [x, y] = d3.pointer(event);
      nodes.push({
        id: Date.now(),
        label: "New Node",
        color: "#5555ff",
        x, y
      });
      selectedNode = null;
      update();
    });

    svg.on("dblclick", function (event) {
      const [x, y] = d3.pointer(event);
      const clicked = nodes.find(n =>
        Math.hypot(n.x - x, n.y - y) < 30
      );
      if (clicked) {
        editingNode = clicked;
        document.querySelector(".edit-box").style.display = "flex";
        document.getElementById("node-label").value = clicked.label;
        document.getElementById("node-color").value = clicked.color;
      }
    });

    document.getElementById("save-node").onclick = () => {
      if (!editingNode) return;
      editingNode.label = document.getElementById("node-label").value;
      editingNode.color = document.getElementById("node-color").value;
      editingNode = null;
      document.querySelector(".edit-box").style.display = "none";
      update();
    };

    update();
  </script>
</body>
</html>
